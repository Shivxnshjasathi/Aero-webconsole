<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aero Visual Console</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');

        body { 
            background: linear-gradient(135deg, #f6f9fc 0%, #eef2f7 100%);
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow: hidden; 
            touch-action: pan-x pan-y; 
            color: #334155;
        }
        
        .bg-blob {
            position: absolute; top: -20%; right: -10%; width: 800px; height: 800px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, rgba(168, 85, 247, 0.05) 50%, transparent 70%);
            filter: blur(60px); z-index: -1; animation: float 10s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-20px, 30px); } }

        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .emoji-icon { font-style: normal; line-height: 1; display: inline-flex; align-items: center; justify-content: center; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); }
        .glass-card { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px rgba(31, 38, 135, 0.05); transition: all 0.3s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes slideUpMobile { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .animate-pop-in { animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-slide-up-mobile { animation: slideUpMobile 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .toast { animation: slideUp 0.3s ease-out forwards; }

        .drag-over { border: 2px dashed #6366f1; background-color: rgba(99, 102, 241, 0.05); transform: scale(1.01); }
        .code-input { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; line-height: 1.6; tab-size: 2; }
        .tree-line { position: absolute; left: 11px; top: 0; bottom: 0; width: 1px; background: linear-gradient(to bottom, #e2e8f0 0%, #e2e8f0 100%); }
        
        @media (max-width: 768px) {
            .mobile-modal { border-bottom-left-radius: 0; border-bottom-right-radius: 0; bottom: 0; top: auto; transform: none; max-height: 90vh; }
        }
    </style>
</head>
<body>
    <div class="bg-blob"></div>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAuEEceU4anDuys1MoxksGkoFV9D9J0KGA",
            authDomain: "aero-backend-6f7b1.firebaseapp.com",
            projectId: "aero-backend-6f7b1",
            storageBucket: "aero-backend-6f7b1.firebasestorage.app",
            messagingSenderId: "147697876494",
            appId: "1:147697876494:web:0eaf39ea6f98a76898865f",
            measurementId: "G-X911SP4TCZ"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. WIDGET TEMPLATES ---
        const WIDGET_TEMPLATES = {
            'Scaffold': { type: 'Scaffold', description: 'Page Structure', backgroundColor: '#F5F5F5', appBar: null, body: null, floatingActionButton: null },
            'AppBar': { type: 'AppBar', description: 'Header Bar', title: { type: 'Text', data: 'Title', color: '#FFFFFF' }, backgroundColor: '#6200EA', actions: [] },
            'Column': { type: 'Column', description: 'Vertical Stack', crossAxisAlignment: 'start', mainAxisAlignment: 'start', children: [] },
            'Row': { type: 'Row', description: 'Horizontal Stack', crossAxisAlignment: 'center', mainAxisAlignment: 'start', children: [] },
            'ListView': { type: 'ListView', description: 'Scrollable List', padding: [0,0,0,0], children: [] },
            'Container': { type: 'Container', description: 'Box & Styling', color: '#FFFFFF', padding: [0,0,0,0], child: null },
            'Card': { type: 'Card', description: 'Shadow Box', elevation: 2, color: '#FFFFFF', margin: [4,4,4,4], child: null },
            'Padding': { type: 'Padding', description: 'Add Spacing', padding: [8,8,8,8], child: null },
            'Stack': { type: 'Stack', description: 'Layers Z-Index', alignment: 'center', children: [] },
            'Center': { type: 'Center', description: 'Center Align', child: null },
            'Expanded': { type: 'Expanded', description: 'Fill Available', flex: 1, child: null },
            'Text': { type: 'Text', description: 'Typography', data: 'New Text', style: 'bodyMedium', color: '#000000' },
            'Icon': { type: 'Icon', description: 'Symbol', icon: 'home', size: 24, color: '#000000' },
            'ElevatedButton': { type: 'ElevatedButton', description: 'Primary Button', onPressed: 'ACTION', child: { type: 'Text', data: 'Button' } },
            'OutlinedButton': { type: 'OutlinedButton', description: 'Secondary Button', onPressed: 'ACTION', child: { type: 'Text', data: 'Button' } },
            'Switch': { type: 'Switch', description: 'Toggle Switch', value: true },
            'Checkbox': { type: 'Checkbox', description: 'Check Box', value: false },
            'Image': { type: 'Image', description: 'Picture URL', url: 'https://via.placeholder.com/150', width: 100, height: 100, fit: 'cover' },
            'SizedBox': { type: 'SizedBox', description: 'Spacer Box', height: 20, width: 20 },
            'Divider': { type: 'Divider', description: 'Separator Line', height: 1, color: '#E0E0E0' },
            'TextField': { type: 'TextField', description: 'Text Input', label: 'Label', hintText: 'Hint...', filled: true }
        };

        const WIDGET_SLOTS = {
            'Scaffold': ['appBar', 'body', 'floatingActionButton'],
            'Container': ['child'], 'Card': ['child'], 'Padding': ['child'], 'Center': ['child'],
            'SizedBox': ['child'], 'Expanded': ['child'], 'AppBar': ['title'],
            'ElevatedButton': ['child'], 'OutlinedButton': ['child']
        };

        const Icon = ({ name, size = 16, className }) => {
            const iconMap = {
                'layout': 'üî≤', 'type': 'Tt', 'image': 'üñºÔ∏è', 'box': '‚¨ú', 'mouse-pointer-2': 'üëÜ',
                'plus': '+', 'trash-2': 'üóëÔ∏è', 'loader-2': '‚è≥', 'rocket': 'üöÄ', 'x': '‚úï',
                'alert-triangle': '‚ö†Ô∏è', 'check': '‚úÖ', 'eye': 'üëÅÔ∏è', 'code': '‚ö°', 'settings': '‚öôÔ∏è',
                'folder': 'üìÅ', 'file': 'üìÑ', 'git-diff': '‚ÜîÔ∏è', 'save': 'üíæ', 'download': 'üì•',
                'move': '‚ÜïÔ∏è', 'menu': '‚ò∞', 'layers': 'üìö', 'sliders': 'üéöÔ∏è', 'edit': '‚úèÔ∏è',
                'container': 'üì¶', 'stack': 'ü•û', 'center': 'üéØ', 'icon': '‚≠ê', 'expand': '‚ÜîÔ∏è', 
                'list': 'üìú', 'divider': '‚ûñ', 'scaffold': 'üèóÔ∏è', 'card': 'üÉè', 'button': 'üîò', 'input': 'üìù',
                'home': 'üè†', 'search': 'üîç'
            };
            return <span className={`emoji-icon transition-transform duration-200 ${className || ''}`} style={{ fontSize: size }}>{iconMap[name] || '?'}</span>;
        };

        const Toast = ({ message, onClose }) => {
            React.useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            return (
                <div className="fixed bottom-20 md:bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur-md text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 text-sm font-semibold z-50 toast border border-slate-700/50 whitespace-nowrap">
                    <div className="bg-emerald-500 rounded-full p-1 shadow-lg shadow-emerald-500/30"><Icon name="check" size={12} className="text-white"/></div>
                    {message}
                </div>
            );
        };

        const getWidgetChildren = (node) => {
            const children = [];
            if (!node) return children;
            if (Array.isArray(node.children)) node.children.forEach((child, i) => children.push({ key: 'children', index: i, node: child, pathKey: 'children' }));
            ['child', 'body', 'appBar', 'floatingActionButton', 'title', 'leading'].forEach(key => {
                if (node[key] && typeof node[key] === 'object' && node[key].type) children.push({ key: key, index: null, node: node[key], pathKey: key });
            });
            ['actions'].forEach(key => {
                if (Array.isArray(node[key])) node[key].forEach((child, i) => children.push({ key: key, index: i, node: child, pathKey: key }));
            });
            return children;
        };

        const WidgetTreeItem = ({ node, path, index, level = 0, selectedPath, setSelectedPath, setInspectNode, label, onAddSlot }) => {
            const isSelected = JSON.stringify(path) === JSON.stringify(selectedPath);
            const children = getWidgetChildren(node);
            const hasChildren = children.length > 0;
            const [isHovered, setIsHovered] = React.useState(false);
            const [isExpanded, setIsExpanded] = React.useState(true);

            const potentialSlots = WIDGET_SLOTS[node.type] || [];
            const emptySlots = potentialSlots.filter(slot => !node[slot]);

            let widgetIcon = 'box';
            const type = node.type || 'Unknown';
            if (['Column', 'Row'].includes(type)) widgetIcon = 'layout';
            else if (type === 'Text') widgetIcon = 'type';
            else if (type === 'Image') widgetIcon = 'image';
            else if (['Container', 'Center', 'SizedBox', 'Expanded'].includes(type)) widgetIcon = 'container';
            else if (type === 'Stack') widgetIcon = 'stack';
            else if (type === 'Scaffold') widgetIcon = 'scaffold';
            else if (['Card', 'Padding'].includes(type)) widgetIcon = 'card';
            else if (type.includes('Button') || ['Switch', 'Checkbox'].includes(type)) widgetIcon = 'button';
            else if (type === 'TextField') widgetIcon = 'input';
            else if (type === 'Icon') widgetIcon = 'icon';
            else if (type === 'ListView') widgetIcon = 'list';

            let displayName = type;
            if (label) displayName = `${label}: ${type}`;

            return (
                <div className="relative">
                    <div 
                        className={`group flex items-center justify-between py-2.5 px-3 cursor-pointer text-sm mb-1.5 rounded-xl transition-all duration-200 border
                            ${isSelected 
                                ? 'bg-gradient-to-r from-indigo-600 to-indigo-500 text-white shadow-lg shadow-indigo-500/25 border-transparent scale-[1.01]' 
                                : 'bg-transparent border-transparent hover:bg-white hover:border-slate-100 hover:shadow-sm text-slate-600'}
                        `}
                        style={{ marginLeft: `${level * 14}px` }}
                        onClick={(e) => { e.stopPropagation(); setSelectedPath(path); }}
                        onMouseEnter={() => setIsHovered(true)}
                        onMouseLeave={() => setIsHovered(false)}
                    >
                        <div className="flex items-center overflow-hidden">
                            {(hasChildren || emptySlots.length > 0) && (
                                <span onClick={(e) => { e.stopPropagation(); setIsExpanded(!isExpanded); }} className={`mr-2 w-5 h-5 flex items-center justify-center rounded-full transition-all ${isSelected ? 'bg-white/20 hover:bg-white/30 text-white' : 'hover:bg-slate-200 text-slate-400'}`}>
                                    <span className={`text-[9px] transition-transform duration-200 ${isExpanded ? 'rotate-90' : ''}`}>‚ñ∂</span>
                                </span>
                            )}
                            {!(hasChildren || emptySlots.length > 0) && <span className="w-7"></span>}
                            
                            <span className={`mr-3 text-lg ${isSelected ? 'opacity-100' : 'opacity-70 group-hover:scale-110 transition-transform'}`}><Icon name={widgetIcon} /></span>
                            <span className="truncate tracking-tight font-medium">{displayName}</span>
                        </div>
                        
                        <button onClick={(e) => { e.stopPropagation(); setInspectNode(node); }} className={`w-7 h-7 flex items-center justify-center rounded-lg transition-all ${isSelected ? 'bg-white/20 text-white hover:bg-white/30' : 'opacity-0 group-hover:opacity-100 text-slate-400 hover:bg-slate-100 hover:text-indigo-600'}`} title="Inspect Code">
                            <Icon name="code" size={14}/>
                        </button>
                    </div>
                    
                    {isExpanded && (
                        <div className="relative">
                            <div className="absolute left-[11px] top-0 bottom-3 w-px bg-slate-200/60" style={{ left: `${(level * 14) + 18}px` }}></div>
                            
                            {children.map((childItem, i) => {
                                const childPath = [...path, childItem.pathKey];
                                if (childItem.index !== null) childPath.push(childItem.index);
                                return (
                                    <WidgetTreeItem 
                                        key={`${childItem.key}-${childItem.index || 0}`} 
                                        node={childItem.node} 
                                        path={childPath} 
                                        index={i} 
                                        level={level + 1} 
                                        selectedPath={selectedPath} 
                                        setSelectedPath={setSelectedPath} 
                                        setInspectNode={setInspectNode} 
                                        label={childItem.index === null ? childItem.key : null} 
                                        onAddSlot={onAddSlot}
                                    />
                                );
                            })}
                            {emptySlots.map((slot) => (
                                <div 
                                    key={slot}
                                    className="flex items-center py-2 px-3 cursor-pointer text-xs mb-1 rounded-lg hover:bg-emerald-50 text-slate-400 hover:text-emerald-600 transition-all group border border-transparent hover:border-emerald-100 ml-4"
                                    style={{ marginLeft: `${(level + 1) * 14}px` }}
                                    onClick={(e) => { e.stopPropagation(); onAddSlot(path, slot); }}
                                >
                                    <div className="w-5 h-5 rounded-full bg-slate-100 group-hover:bg-emerald-100 flex items-center justify-center mr-2.5 transition-colors shadow-sm">
                                        <span className="text-slate-400 group-hover:text-emerald-600 text-[10px] font-bold">+</span>
                                    </div>
                                    <span className="font-medium italic">Add {slot}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const CodeEditorModal = ({ isOpen, onClose, originalSpec, currentSpec, onSave }) => {
            const [mode, setMode] = React.useState('edit');
            const [code, setCode] = React.useState('');
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                if (isOpen) { setCode(JSON.stringify(currentSpec, null, 2)); setMode('edit'); setError(null); }
            }, [isOpen, currentSpec]);

            const handleSave = () => { try { onSave(JSON.parse(code)); onClose(); } catch (e) { setError("Invalid JSON: " + e.message); } };
            if (!isOpen) return null;

            let oldLines = [], newLines = [];
            if (mode === 'diff') {
                const oldStr = originalSpec ? JSON.stringify(originalSpec, null, 2) : '{}';
                oldLines = oldStr.split('\n'); newLines = code.split('\n');
            }

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center z-50 animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-t-3xl md:rounded-2xl shadow-2xl w-full md:w-[90%] md:max-w-6xl h-[90vh] md:h-[85vh] flex flex-col overflow-hidden animate-slide-up-mobile md:animate-pop-in mobile-modal" onClick={e => e.stopPropagation()}>
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <div className="flex items-center gap-4"><div className="flex items-center gap-3 text-slate-800"><div className="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center"><Icon name="code" size={20}/></div><div><h3 className="font-bold text-lg">Code Editor</h3><p className="text-xs text-slate-500">Direct JSON Manipulation</p></div></div><div className="flex bg-slate-100 rounded-lg p-1 border border-slate-200"><button onClick={() => setMode('edit')} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${mode === 'edit' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Edit</button><button onClick={() => setMode('diff')} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${mode === 'diff' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Diff</button></div></div>
                            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="flex-1 overflow-hidden relative bg-slate-900">
                            {mode === 'edit' ? ( <textarea value={code} onChange={(e) => { setCode(e.target.value); setError(null); }} className="w-full h-full bg-slate-900 text-slate-300 p-6 font-mono text-xs md:text-sm resize-none focus:outline-none custom-scroll code-input leading-relaxed" spellCheck="false" /> ) : ( <div className="flex flex-col md:flex-row h-full text-xs font-mono"><div className="flex-1 border-b md:border-b-0 md:border-r border-slate-700 p-6 overflow-auto custom-scroll bg-slate-900 text-slate-500 h-1/2 md:h-auto select-none opacity-70"><h4 className="font-bold mb-4 uppercase tracking-wider text-[10px] text-slate-400 border-b border-slate-700 pb-2">Original</h4>{oldLines.map((line, i) => <div key={i} className="whitespace-pre px-2 border-l-2 border-transparent">{line}</div>)}</div><div className="flex-1 p-6 overflow-auto custom-scroll bg-slate-900 text-slate-300 h-1/2 md:h-auto"><h4 className="font-bold mb-4 uppercase tracking-wider text-[10px] text-emerald-400 border-b border-slate-700 pb-2">Modified</h4>{newLines.map((line, i) => { const isModified = oldLines[i] !== undefined && oldLines[i] !== line; const isAdded = oldLines[i] === undefined; return <div key={i} className={`whitespace-pre px-2 ${isModified ? 'bg-indigo-500/20 text-indigo-200 border-l-2 border-indigo-500' : isAdded ? 'bg-emerald-500/10 text-emerald-200 border-l-2 border-emerald-500' : 'border-l-2 border-transparent'}`}>{line}</div>; })}</div></div> )}
                        </div>
                        <div className="p-5 border-t border-slate-100 bg-white flex justify-between items-center pb-8 md:pb-5"><div className="text-rose-500 text-xs font-semibold px-2">{error && <span className="flex items-center gap-2 bg-rose-50 px-3 py-1.5 rounded-lg"><Icon name="alert-triangle" size={14}/> {error}</span>}</div><div className="flex gap-3"><button onClick={onClose} className="px-5 py-2.5 text-slate-500 hover:text-slate-700 text-sm font-bold transition-colors">Cancel</button><button onClick={handleSave} className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 flex items-center gap-2 transition-transform active:scale-95"><Icon name="check" size={16}/> Apply Changes</button></div></div>
                    </div>
                </div>
            );
        };

        const PropertyEditor = ({ node, selectedPath, updateNode, deleteNode, setShowAddModal, setTargetSlot }) => {
            if (!node) return <div className="h-full flex flex-col items-center justify-center text-slate-400 animate-fade-in p-8 text-center"><div className="w-24 h-24 bg-white rounded-3xl flex items-center justify-center mb-6 shadow-xl shadow-indigo-100/50 animate-float"><div className="text-indigo-200"><Icon name="mouse-pointer-2" size={48} /></div></div><h3 className="text-xl font-bold text-slate-700 mb-2">No Layer Selected</h3><p className="font-medium text-slate-400 text-sm max-w-xs">Tap on a layer from the list to customize its look and feel.</p></div>;
            const getEdgeInsets = (arr) => Array.isArray(arr) && arr.length === 4 ? arr[0] : (typeof arr === 'number' ? arr : 0);
            const canAddChild = node.children || (WIDGET_SLOTS[node.type] && WIDGET_SLOTS[node.type].some(slot => slot === 'child' || slot === 'body')); 
            const hasLayoutFields = ['Text', 'Column', 'Row', 'Padding', 'Container', 'ListView', 'ElevatedButton', 'OutlinedButton', 'Card', 'Icon', 'Image', 'SizedBox', 'Expanded', 'Stack', 'Divider', 'Switch', 'Checkbox', 'TextField', 'Center'].includes(node.type);

            return (
                <div className="w-full h-full overflow-y-auto custom-scroll animate-fade-in pb-24 md:pb-0">
                    <div className="max-w-3xl mx-auto p-4 md:p-8">
                        <div className="glass-card rounded-2xl overflow-hidden">
                            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white/50 backdrop-blur-sm sticky top-0 z-10">
                                <div><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-3"><span className="text-3xl"><Icon name={node.type === 'Column' || node.type === 'Row' ? 'layout' : node.type.toLowerCase()}/></span>{node.type}</h2><div className="text-xs text-slate-400 mt-1 font-mono flex items-center gap-1 ml-1"><Icon name="layers" size={12} /><span className="truncate max-w-[200px]">{selectedPath.length ? selectedPath.join(' / ') : 'Root'}</span></div></div>
                                <div className="flex gap-2">
                                    { canAddChild && <button onClick={() => { setTargetSlot(null); setShowAddModal(true); }} className="px-4 py-2 bg-white border border-slate-200 text-indigo-600 rounded-lg text-sm font-bold hover:bg-indigo-50 hover:border-indigo-200 transition-all shadow-sm flex items-center gap-2"><Icon name="plus" size={14}/> Add</button> }
                                    {selectedPath.length > 0 && <button onClick={() => deleteNode(selectedPath)} className="px-4 py-2 bg-white border border-slate-200 text-rose-500 rounded-lg text-sm font-bold hover:bg-rose-50 hover:border-rose-200 transition-all shadow-sm flex items-center gap-2"><Icon name="trash-2" size={14}/> Del</button>}
                                </div>
                            </div>
                            <div className="p-8 space-y-8 bg-white/30">
                                <div>
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><Icon name="edit" size={12}/> Core Properties</h4>
                                    <div className="grid gap-6">
                                        <div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">ID Reference</label><input type="text" value={node.id || ''} onChange={(e) => updateNode(selectedPath, { id: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all shadow-sm" placeholder="e.g. hero_section"/></div>
                                        {(node.type === 'Scaffold' || node.type === 'Container' || node.type === 'Card' || node.type === 'AppBar') && (
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Background</label><div className="flex gap-3 items-center"><div className="relative w-12 h-12 rounded-xl overflow-hidden shadow-sm border border-slate-200 bg-white"><input type="color" value={node.backgroundColor || node.color || '#FFFFFF'} onChange={(e) => updateNode(selectedPath, { [node.type === 'Scaffold' || node.type === 'AppBar' ? 'backgroundColor' : 'color']: e.target.value })} className="absolute -top-2 -left-2 w-16 h-16 p-0 border-none cursor-pointer"/></div><input type="text" value={node.backgroundColor || node.color || '#FFFFFF'} onChange={(e) => updateNode(selectedPath, { [node.type === 'Scaffold' || node.type === 'AppBar' ? 'backgroundColor' : 'color']: e.target.value })} className="flex-1 bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm font-mono uppercase shadow-sm"/></div></div>
                                        )}
                                    </div>
                                </div>
                                {hasLayoutFields && (
                                    <div>
                                        <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><Icon name="sliders" size={12}/> Layout & Style</h4>
                                        <div className="grid gap-6">
                                            {node.type === 'Text' && (<><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Content</label><textarea rows="2" value={node.data || ''} onChange={(e) => updateNode(selectedPath, { data: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-none shadow-sm"/></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Typography</label><select value={node.style || 'bodyMedium'} onChange={(e) => updateNode(selectedPath, { style: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none h-[46px] shadow-sm"><option value="displayLarge">Display XL</option><option value="headlineSmall">Headline S</option><option value="bodyLarge">Body L</option><option value="bodyMedium">Body M</option><option value="labelSmall">Label S</option></select></div><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Text Color</label><div className="flex items-center border border-slate-200 rounded-xl bg-white p-1 shadow-sm"><div className="w-8 h-8 rounded-lg overflow-hidden border border-slate-200 mr-2 relative"><input type="color" value={node.textColor || '#000000'} onChange={(e) => updateNode(selectedPath, { textColor: e.target.value })} className="absolute -top-1 -left-1 w-10 h-10 border-none p-0 cursor-pointer"/></div><input type="text" value={node.textColor || '#000000'} onChange={(e) => updateNode(selectedPath, { textColor: e.target.value })} className="w-full bg-transparent text-sm font-mono outline-none uppercase"/></div></div></div></>)}
                                            {(node.type === 'Column' || node.type === 'Row') && (<div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Main Axis</label><select value={node.mainAxisAlignment || 'start'} onChange={(e) => updateNode(selectedPath, { mainAxisAlignment: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none shadow-sm"><option value="start">Start</option><option value="center">Center</option><option value="end">End</option><option value="spaceBetween">Space Between</option></select></div><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Cross Axis</label><select value={node.crossAxisAlignment || 'start'} onChange={(e) => updateNode(selectedPath, { crossAxisAlignment: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none shadow-sm"><option value="start">Start</option><option value="center">Center</option><option value="end">End</option><option value="stretch">Stretch</option></select></div></div>)}
                                            {(node.type === 'Padding' || node.type === 'Container' || node.type === 'ListView') && (<div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Padding (All Sides)</label><div className="relative"><span className="absolute left-4 top-3.5 text-slate-400 text-xs font-bold">px</span><input type="number" value={getEdgeInsets(node.padding)} onChange={(e) => { const val = Number(e.target.value); updateNode(selectedPath, { padding: [val, val, val, val] }); }} className="w-full bg-white border border-slate-200 rounded-xl px-4 pl-10 py-3 text-sm outline-none focus:border-indigo-500 transition-all shadow-sm"/></div></div>)}
                                            {(node.type === 'ElevatedButton' || node.type === 'OutlinedButton') && (<div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Action ID</label><input type="text" value={node.onPressed || ''} onChange={(e) => updateNode(selectedPath, { onPressed: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm focus:border-indigo-500 transition-all shadow-sm" placeholder="e.g. SUBMIT_FORM"/></div>)}
                                            {node.type === 'Card' && (<div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Elevation</label><input type="number" value={node.elevation || 0} onChange={(e) => updateNode(selectedPath, { elevation: Number(e.target.value) })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 shadow-sm"/></div>)}
                                            {node.type === 'Icon' && (<div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Icon</label><input type="text" value={node.icon || 'home'} onChange={(e) => updateNode(selectedPath, { icon: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 shadow-sm"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Size</label><input type="number" value={node.size || 24} onChange={(e) => updateNode(selectedPath, { size: Number(e.target.value) })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 shadow-sm"/></div></div>)}
                                            {node.type === 'Image' && (<div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Image URL</label><input type="text" value={node.url || ''} onChange={(e) => updateNode(selectedPath, { url: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 shadow-sm"/></div>)}
                                            {(node.type === 'SizedBox' || node.type === 'Image' || node.type === 'Container') && (<div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Width</label><input type="number" value={node.width || ''} placeholder="Auto" onChange={(e) => updateNode(selectedPath, { width: e.target.value ? Number(e.target.value) : null })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 shadow-sm"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Height</label><input type="number" value={node.height || ''} placeholder="Auto" onChange={(e) => updateNode(selectedPath, { height: e.target.value ? Number(e.target.value) : null })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 shadow-sm"/></div></div>)}
                                            {node.type === 'Stack' && (<div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Alignment</label><select value={node.alignment || 'center'} onChange={(e) => updateNode(selectedPath, { alignment: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none shadow-sm"><option value="center">Center</option><option value="topLeft">Top Left</option><option value="bottomRight">Bottom Right</option></select></div>)}
                                            {node.type === 'Expanded' && (<div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Flex</label><input type="number" value={node.flex || 1} onChange={(e) => updateNode(selectedPath, { flex: Number(e.target.value) })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 shadow-sm"/></div>)}
                                            {node.type === 'Divider' && (<div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Height</label><input type="number" value={node.height || 1} onChange={(e) => updateNode(selectedPath, { height: Number(e.target.value) })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none shadow-sm"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Color</label><input type="color" value={node.color || '#E0E0E0'} onChange={(e) => updateNode(selectedPath, { color: e.target.value })} className="h-10 w-full p-0 border-none rounded cursor-pointer"/></div></div>)}
                                            {(node.type === 'Switch' || node.type === 'Checkbox') && (<div className="flex items-center gap-3 bg-white border border-slate-200 rounded-xl px-4 py-3 shadow-sm"><input type="checkbox" checked={node.value || false} onChange={(e) => updateNode(selectedPath, { value: e.target.checked })} className="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500"/><label className="text-sm font-medium text-slate-700">Initial Value (Active/Checked)</label></div>)}
                                            {node.type === 'TextField' && (<div><label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Label Text</label><input type="text" value={node.label || ''} onChange={(e) => updateNode(selectedPath, { label: e.target.value })} className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 shadow-sm"/></div>)}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [specId, setSpecId] = React.useState('home_screen');
            const [spec, setSpec] = React.useState(null);
            const [originalSpec, setOriginalSpec] = React.useState(null); 
            const [selectedPath, setSelectedPath] = React.useState([]); 
            const [loading, setLoading] = React.useState(false);
            const [status, setStatus] = React.useState('Initializing...');
            const [showAddModal, setShowAddModal] = React.useState(false);
            const [mobileTab, setMobileTab] = React.useState('tree');
            const [showDiffModal, setShowDiffModal] = React.useState(false);
            const [inspectNode, setInspectNode] = React.useState(null);
            const [authError, setAuthError] = React.useState(null);
            const [dbError, setDbError] = React.useState(null);
            const [targetSlot, setTargetSlot] = React.useState(null);
            const [toast, setToast] = React.useState(null);

            React.useEffect(() => { initializeApp(); }, []); 
            React.useEffect(() => { if (!loading && !dbError) fetchSpec(); }, [specId]);
            React.useEffect(() => { if (selectedPath.length > 0 && window.innerWidth < 768) setMobileTab('properties'); }, [selectedPath]);

            const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

            const initializeApp = async () => {
                setLoading(true); setAuthError(null); setDbError(null);
                try { await auth.signInAnonymously(); setStatus('Ready'); await fetchSpec(); } catch (err) { setAuthError(err.message); } setLoading(false);
            };

            const fetchSpec = async () => {
                setStatus('Loading...');
                try {
                    const doc = await db.collection('aero_specs').doc(specId).get();
                    let data;
                    if (doc.exists && doc.data().spec) { data = doc.data().spec; setStatus('Loaded'); } 
                    else { 
                        data = {
                            type: 'Scaffold', backgroundColor: '#F5F5F5',
                            appBar: { type: 'AppBar', title: { type: 'Text', data: 'New Screen', color: '#FFFFFF' }, backgroundColor: '#6200EA', actions: [] },
                            body: { type: 'Center', child: { type: 'Text', data: 'Start building!', style: 'bodyMedium' } },
                            floatingActionButton: { type: 'ElevatedButton', onPressed: 'ADD_ACTION', backgroundColor: '#03DAC6', child: { type: 'Icon', icon: 'add', color: '#000000', size: 24 } }
                        };
                        setStatus('New Spec'); 
                    }
                    setSpec(data); setOriginalSpec(JSON.parse(JSON.stringify(data))); setSelectedPath([]); setDbError(null);
                } catch (err) { setDbError(err.message); setStatus('Error'); }
            };

            const saveSpec = async () => {
                setLoading(true); setStatus('Saving...');
                try { await db.collection('aero_specs').doc(specId).set({ spec, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); setOriginalSpec(JSON.parse(JSON.stringify(spec))); setStatus('Saved!'); showToast("Design Saved!"); setTimeout(() => setStatus('Ready'), 3000); } catch (err) { showToast("Error: " + err.message); setStatus('Error'); } setLoading(false);
            };

            const getNode = (path, currentSpec = spec) => {
                if (path.length === 0) return currentSpec;
                let current = currentSpec;
                for (let key of path) { if (current && current[key] !== undefined) current = current[key]; else return null; }
                return current;
            };

            const updateNode = (path, newData) => {
                const newSpec = JSON.parse(JSON.stringify(spec));
                if (path.length === 0) { setSpec({ ...newSpec, ...newData }); return; }
                let current = newSpec;
                for (let i = 0; i < path.length - 1; i++) current = current[path[i]];
                current[path[path.length - 1]] = { ...current[path[path.length - 1]], ...newData };
                setSpec(newSpec);
            };

            const handleAddSlot = (path, slotName) => {
                setTargetSlot({ path, slotName });
                setSelectedPath(path);
                setShowAddModal(true);
            };

            const addChild = (parentPath, widgetType) => {
                const newSpec = JSON.parse(JSON.stringify(spec));
                const newWidget = JSON.parse(JSON.stringify(WIDGET_TEMPLATES[widgetType]));
                
                // Determine the actual parent and where to add
                let path = targetSlot ? targetSlot.path : parentPath;
                let parent = newSpec;
                if (path.length > 0) { for (let key of path) parent = parent[key]; }

                // 1. Target Specific Slot (via Tree '+') - Highest Priority
                if (targetSlot) {
                    if (parent[targetSlot.slotName]) { showToast(`Slot occupied!`); } 
                    else { parent[targetSlot.slotName] = newWidget; showToast("Widget Added!"); }
                    setTargetSlot(null); // CRITICAL: Clear target after use
                } 
                // 2. Multi-child Container
                else if (Array.isArray(parent.children)) {
                    parent.children.push(newWidget); showToast("Added to Stack/List");
                } 
                // 3. Single-Child Container - AUTO WRAP LOGIC
                else if (parent.hasOwnProperty('child')) {
                    if (!parent.child) { parent.child = newWidget; showToast("Child Added"); } else {
                        const existingChild = parent.child; 
                        parent.child = { type: 'Column', crossAxisAlignment: 'center', children: [existingChild, newWidget] }; 
                        showToast("Wrapped in Column");
                    }
                } 
                // 4. Scaffold Body - AUTO WRAP LOGIC
                else if (parent.type === 'Scaffold' && parent.hasOwnProperty('body')) {
                    if (!parent.body) { parent.body = newWidget; showToast("Body Added"); } else {
                        const existingBody = parent.body; 
                        parent.body = { type: 'Column', crossAxisAlignment: 'start', children: [existingBody, newWidget] }; 
                        showToast("Body wrapped in Column");
                    }
                } else { showToast("Cannot add here."); return; }
                setSpec(newSpec); setShowAddModal(false);
            };

            const deleteNode = (path) => {
                if (path.length === 0) { showToast("Cannot delete root."); return; }
                const newSpec = JSON.parse(JSON.stringify(spec));
                let parent = newSpec;
                for (let i = 0; i < path.length - 1; i++) parent = parent[path[i]];
                const keyToDelete = path[path.length - 1];
                if (typeof keyToDelete === 'number') {
                    let grandParent = newSpec;
                    for (let i = 0; i < path.length - 2; i++) grandParent = grandParent[path[i]];
                    const arrayKey = path[path.length - 2];
                    if (Array.isArray(grandParent[arrayKey])) grandParent[arrayKey].splice(keyToDelete, 1);
                } else {
                    let parentObj = newSpec;
                    for (let i = 0; i < path.length - 1; i++) parentObj = parentObj[path[i]];
                    parentObj[keyToDelete] = null;
                }
                setSpec(newSpec); setSelectedPath([]); 
            };

            const handleEditorSave = (newSpec) => { setSpec(newSpec); setTimeout(saveSpec, 0); };

            if ((authError || dbError) && !spec) { return <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 animate-fade-in"><h2 className="text-xl font-bold text-red-600 mb-4 flex items-center gap-2"><Icon name="alert-triangle" size={24}/> Connection Issue</h2>{authError && <div className="mb-4 text-sm text-slate-700"><strong>Auth Error:</strong> {authError}</div>}{dbError && <div className="mb-4 text-sm text-slate-700"><strong>Database Error:</strong> {dbError}</div>}<button onClick={initializeApp} className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Retry</button></div></div>; }
            if (!spec) return <div className="flex flex-col items-center justify-center h-screen bg-slate-50 text-slate-400 gap-4"><div className="animate-spin text-indigo-500"><Icon name="loader-2" size={40}/></div><p className="font-medium animate-pulse">{status}</p></div>;

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-800">
                    <header className="h-20 glass z-20 px-4 md:px-8 flex items-center justify-between shrink-0 sticky top-0 shadow-sm backdrop-blur-md bg-white/70">
                        <div className="flex items-center gap-3 md:gap-6 min-w-0">
                            <div className="font-bold text-xl text-slate-800 flex items-center gap-2 md:gap-3 tracking-tight shrink-0">
                                <div className="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white text-sm md:text-lg font-bold shadow-lg shadow-indigo-500/30">A</div>
                                <span className="hidden md:inline bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-slate-600">Aero</span>
                            </div>
                            <div className="flex items-center gap-2 bg-white p-1 md:p-1.5 rounded-xl border border-slate-200 shadow-sm shrink-1 min-w-0">
                                <span className="pl-2 text-xs font-bold text-slate-400 uppercase tracking-wider hidden lg:inline">Project:</span>
                                <input className="w-20 md:w-32 lg:w-40 text-sm bg-transparent border-none focus:outline-none text-slate-700 font-semibold min-w-0" value={specId} onChange={(e)=>setSpecId(e.target.value)} />
                                <button onClick={() => fetchSpec()} className="px-3 py-1 md:px-4 md:py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 transition-colors shrink-0">Load</button>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 md:gap-4 shrink-0 ml-2">
                            <div className={`text-[10px] font-bold px-2 py-1 md:px-3 md:py-1.5 rounded-full uppercase tracking-wider hidden xl:block border ${status.includes('Error') ? 'bg-rose-50 text-rose-600 border-rose-100' : 'bg-emerald-50 text-emerald-600 border-emerald-100'}`}>{status}</div>
                            <button onClick={() => setShowDiffModal(true)} className="flex items-center gap-2 px-3 py-2 md:px-4 md:py-2.5 bg-white border border-slate-200 text-slate-600 hover:text-indigo-600 hover:border-indigo-200 rounded-xl text-sm font-bold transition-all shadow-sm hover:shadow-md"><Icon name="git-diff" size={18} /><span className="hidden lg:inline">Editor</span></button>
                            <button onClick={saveSpec} disabled={loading} className={`flex items-center gap-2 px-4 py-2 md:px-6 md:py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-500/30 transition-all transform active:scale-95 ${loading ? 'bg-slate-200 text-slate-400 cursor-not-allowed shadow-none' : 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:to-purple-700'}`}>{loading ? <Icon name="loader-2" className="animate-spin" size={18}/> : <Icon name="rocket" size={18}/>}<span className="hidden md:inline">Publish</span></button>
                        </div>
                    </header>
                    
                    <div className="md:hidden flex border-b border-slate-200 bg-white"><button onClick={() => setMobileTab('tree')} className={`flex-1 py-3 text-sm font-medium flex items-center justify-center gap-2 ${mobileTab === 'tree' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500'}`}><Icon name="layers" size={14}/> Layers</button><button onClick={() => setMobileTab('properties')} className={`flex-1 py-3 text-sm font-medium flex items-center justify-center gap-2 ${mobileTab === 'properties' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500'}`}><Icon name="sliders" size={14}/> Properties</button></div>

                    <div className="flex flex-1 overflow-hidden relative">
                        <div className={`w-full md:w-80 bg-white/60 border-r border-slate-200 flex flex-col z-10 backdrop-blur-md ${mobileTab === 'tree' ? 'flex' : 'hidden md:flex'}`}><div className="p-6 border-b border-slate-100/50"><div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex justify-between items-center">Layers<span className="bg-indigo-50 text-indigo-500 px-2 py-0.5 rounded-full text-[9px] font-bold">Root</span></div></div><div className="flex-1 overflow-y-auto custom-scroll py-4 px-4 relative"><div className="absolute left-[27px] top-0 bottom-0 w-px bg-slate-200/60 z-0"></div><WidgetTreeItem node={spec} path={[]} index={0} selectedPath={selectedPath} setSelectedPath={setSelectedPath} setInspectNode={setInspectNode} onAddSlot={handleAddSlot} /></div></div>
                        <div className={`flex-1 bg-transparent relative ${mobileTab === 'properties' ? 'flex' : 'hidden md:flex'}`}><PropertyEditor node={getNode(selectedPath)} selectedPath={selectedPath} updateNode={updateNode} deleteNode={deleteNode} setShowAddModal={setShowAddModal} setTargetSlot={setTargetSlot} /></div>
                    </div>

                    <CodeEditorModal isOpen={showDiffModal} onClose={() => setShowDiffModal(false)} originalSpec={originalSpec} currentSpec={spec} onSave={handleEditorSave} />
                    
                    {showAddModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={() => { setShowAddModal(false); setTargetSlot(null); }}>
                            <div className="glass-panel bg-white/90 rounded-3xl shadow-2xl w-[90%] max-w-5xl max-h-[85vh] overflow-hidden transform scale-100 transition-all animate-pop-in" onClick={e => e.stopPropagation()}>
                                <div className="p-8 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-white to-slate-50">
                                    <div><h3 className="font-bold text-slate-800 text-2xl">Add {targetSlot ? targetSlot.slotName : 'Widget'}</h3><p className="text-slate-500 text-sm mt-1 font-medium">Select a component to add to your design</p></div>
                                    <button onClick={() => { setShowAddModal(false); setTargetSlot(null); }} className="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 hover:text-slate-600 hover:bg-slate-200 transition-colors"><Icon name="x" size={20}/></button>
                                </div>
                                <div className="p-8 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto custom-scroll max-h-[60vh] bg-slate-50/50">
                                    {Object.keys(WIDGET_TEMPLATES).filter(key => key !== 'Scaffold').map(key => {
                                        const widget = WIDGET_TEMPLATES[key];
                                        let iconName = key.toLowerCase();
                                        if(key.includes('Button')) iconName = 'button'; if(key === 'Text') iconName = 'type'; if(key === 'Column' || key === 'Row') iconName = 'layout';
                                        return (
                                            <button key={key} onClick={() => addChild(selectedPath, key)} className="group flex flex-col items-center text-center p-5 border border-slate-200 bg-white rounded-2xl hover:border-indigo-500 hover:shadow-xl hover:shadow-indigo-500/10 hover:-translate-y-1 transition-all duration-300">
                                                <div className="w-14 h-14 bg-indigo-50 rounded-2xl mb-4 text-indigo-500 group-hover:bg-indigo-600 group-hover:text-white transition-all duration-300 flex items-center justify-center text-2xl shadow-sm group-hover:shadow-md group-hover:scale-110"><Icon name={iconName} /></div>
                                                <span className="text-sm font-bold text-slate-700 group-hover:text-indigo-700 transition-colors">{key}</span>
                                                <span className="text-[11px] text-slate-400 mt-1.5 font-medium">{widget.description || 'Widget'}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}
                    {inspectNode && (<div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={() => setInspectNode(null)}><div className="bg-slate-900 rounded-2xl shadow-2xl w-[90%] md:w-[500px] max-h-[80vh] flex flex-col border border-slate-700 m-4 overflow-hidden animate-pop-in" onClick={e => e.stopPropagation()}><div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800"><div className="flex items-center gap-2 text-slate-200"><Icon name="eye" size={18} className="text-indigo-400"/><span className="font-bold text-sm">Inspect: {inspectNode.type}</span></div><button onClick={() => setInspectNode(null)} className="text-slate-400 hover:text-white transition-colors"><Icon name="x" size={20}/></button></div><div className="p-0 overflow-y-auto custom-scroll bg-slate-950"><pre className="p-6 text-xs font-mono text-emerald-400 whitespace-pre-wrap font-medium leading-relaxed">{JSON.stringify(inspectNode, (key, value) => (key === 'children' ? '[Array]' : value), 2)}</pre></div></div></div>)}
                    {toast && <Toast message={toast} onClose={() => setToast(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
