<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aero Visual Console</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; overflow: hidden; touch-action: pan-x pan-y; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Utility */
        .emoji-icon { font-style: normal; line-height: 1; display: inline-flex; align-items: center; justify-content: center; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Drag and Drop Styles */
        .drag-over { border: 2px dashed #6366f1; background-color: #e0e7ff; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAuEEceU4anDuys1MoxksGkoFV9D9J0KGA",
            authDomain: "aero-backend-6f7b1.firebaseapp.com",
            projectId: "aero-backend-6f7b1",
            storageBucket: "aero-backend-6f7b1.firebasestorage.app",
            messagingSenderId: "147697876494",
            appId: "1:147697876494:web:0eaf39ea6f98a76898865f",
            measurementId: "G-X911SP4TCZ"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. WIDGET TEMPLATES ---
        const WIDGET_TEMPLATES = {
            'Column': { type: 'Column', crossAxisAlignment: 'start', mainAxisAlignment: 'start', padding: [0, 0, 0, 0], children: [] },
            'Row': { type: 'Row', crossAxisAlignment: 'center', mainAxisAlignment: 'start', children: [] },
            'Text': { type: 'Text', data: 'New Text', style: 'bodyMedium', color: '#000000' },
            'SizedBox': { type: 'SizedBox', height: 20, width: 20 },
            'Image': { type: 'Image', url: 'https://via.placeholder.com/150', width: 100, height: 100 },
            'Button': { type: 'Button', label: 'Click Me', actionType: 'NONE' },
            'TextField': { type: 'TextField', label: 'Enter text', placeholder: 'Placeholder...' }
        };

        // --- 3. HELPER COMPONENTS ---
        const Icon = ({ name, size = 16, className }) => {
            const iconMap = {
                'layout': 'üî≤', 'type': 'Tt', 'image': 'üñºÔ∏è', 'box': '‚¨ú', 'mouse-pointer-2': 'üëÜ',
                'plus': '+', 'trash-2': 'üóëÔ∏è', 'loader-2': '‚è≥', 'rocket': 'üöÄ', 'x': '‚úï',
                'alert-triangle': '‚ö†Ô∏è', 'check': '‚úÖ', 'eye': 'üëÅÔ∏è', 'code': '‚ö°', 'settings': '‚öôÔ∏è',
                'folder': 'üìÅ', 'file': 'üìÑ', 'git-diff': '‚ÜîÔ∏è', 'save': 'üíæ', 'download': 'üì•',
                'move': '‚ÜïÔ∏è', 'menu': '‚ò∞', 'layers': 'üìö', 'sliders': 'üéöÔ∏è'
            };
            return <span className={`emoji-icon ${className || ''}`} style={{ fontSize: size }}>{iconMap[name] || '?'}</span>;
        };

        // --- 4. EXTRACTED SUB-COMPONENTS (Fixed Focus & Added DnD & Touch Support) ---

        const WidgetTreeItem = ({ node, path, index, level = 0, selectedPath, setSelectedPath, setInspectNode, moveNode }) => {
            const isSelected = JSON.stringify(path) === JSON.stringify(selectedPath);
            const hasChildren = node.children && Array.isArray(node.children);
            const [isHovered, setIsHovered] = React.useState(false);
            const [isDragOver, setIsDragOver] = React.useState(false);

            // Desktop Drag Handlers
            const handleDragStart = (e) => {
                e.dataTransfer.setData('application/json', JSON.stringify(path));
                e.dataTransfer.effectAllowed = 'move';
                e.stopPropagation();
            };

            const handleDragOver = (e) => {
                e.preventDefault(); 
                e.dataTransfer.dropEffect = 'move';
                if (!isDragOver) setIsDragOver(true);
            };

            const handleDragLeave = () => {
                setIsDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                try {
                    const sourcePath = JSON.parse(e.dataTransfer.getData('application/json'));
                    moveNode(sourcePath, path);
                } catch(err) { console.error("Drop error", err); }
                e.stopPropagation();
            };

            // Basic Touch Support (Simple tap selection is handled by onClick, complex reordering usually requires a library like dnd-kit for robust touch, 
            // but we'll stick to basic click selection for mobile responsiveness stability here, relying on desktop for heavy reorganization)

            return (
                <div>
                    <div 
                        draggable="true"
                        onDragStart={handleDragStart}
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                        className={`group flex items-center justify-between py-2 px-3 cursor-pointer text-sm mb-1 rounded-md transition-all duration-200
                            ${isSelected ? 'bg-indigo-50 text-indigo-700 font-medium' : 'hover:bg-slate-100 text-slate-600'}
                            ${isDragOver ? 'drag-over ring-2 ring-indigo-400' : ''}
                        `}
                        style={{ paddingLeft: `${level * 16 + 12}px` }}
                        onClick={(e) => { e.stopPropagation(); setSelectedPath(path); }}
                        onMouseEnter={() => setIsHovered(true)}
                        onMouseLeave={() => setIsHovered(false)}
                    >
                        <div className="flex items-center overflow-hidden">
                            {/* Drag Handle Indicator (Desktop) */}
                            <span className={`mr-2 cursor-grab active:cursor-grabbing text-slate-300 hover:text-slate-500 hidden md:inline-block ${isHovered ? 'opacity-100' : 'opacity-0'}`} title="Drag to reorder">
                                <Icon name="move" size={12} />
                            </span>
                            
                            <span className={`mr-2.5 transition-opacity ${isSelected ? 'opacity-100' : 'opacity-60'}`}>
                                {node.type === 'Column' || node.type === 'Row' ? <Icon name="layout" size={14} /> : 
                                 node.type === 'Text' ? <Icon name="type" size={14} /> :
                                 node.type === 'Image' ? <Icon name="image" size={14} /> :
                                 <Icon name="box" size={14} />}
                            </span>
                            <span className="truncate tracking-tight select-none">{node.type}</span>
                            {node.id && <span className={`ml-2 text-[10px] font-mono opacity-60 truncate`}>#{node.id}</span>}
                        </div>
                        
                        <button
                            onClick={(e) => { e.stopPropagation(); setInspectNode(node); }}
                            className={`
                                p-1.5 rounded hover:bg-white transition-all
                                ${(isHovered || isSelected) ? 'opacity-100' : 'opacity-0 md:opacity-0'}
                                /* Show always on mobile if selected */
                                ${isSelected ? 'opacity-100' : ''}
                            `}
                            title="View Node JSON"
                        >
                            <Icon name="eye" size={14} className={isSelected ? "text-indigo-600" : "text-slate-400"}/>
                        </button>
                    </div>
                    
                    {hasChildren && (
                        <div className="relative">
                            <div className="absolute left-[calc(12px+4px)] top-0 bottom-0 w-px bg-slate-200" style={{ left: `${level * 16 + 19}px` }}></div>
                            {node.children.map((child, i) => (
                                <WidgetTreeItem 
                                    key={i} 
                                    node={child} 
                                    path={[...path, 'children', i]} 
                                    index={i} 
                                    level={level + 1}
                                    selectedPath={selectedPath}
                                    setSelectedPath={setSelectedPath}
                                    setInspectNode={setInspectNode}
                                    moveNode={moveNode}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const DiffViewer = ({ originalSpec, spec }) => {
            const oldJson = JSON.stringify(originalSpec, null, 2) || '';
            const newJson = JSON.stringify(spec, null, 2) || '';
            
            const oldLines = oldJson.split('\n');
            const newLines = newJson.split('\n');
            
            return (
                <div className="flex flex-col md:flex-row h-full text-xs font-mono">
                    <div className="flex-1 border-b md:border-b-0 md:border-r border-slate-700 p-4 overflow-auto custom-scroll bg-slate-900 text-slate-400 h-1/2 md:h-auto">
                        <h4 className="text-slate-500 font-bold mb-2 uppercase tracking-wider text-[10px] sticky top-0 bg-slate-900 pb-2">Last Saved (Original)</h4>
                        {oldLines.map((line, i) => (
                            <div key={i} className="whitespace-pre hover:bg-slate-800/50 px-1">{line}</div>
                        ))}
                    </div>
                    <div className="flex-1 p-4 overflow-auto custom-scroll bg-slate-900 text-slate-200 h-1/2 md:h-auto">
                        <h4 className="text-emerald-500 font-bold mb-2 uppercase tracking-wider text-[10px] sticky top-0 bg-slate-900 pb-2">Current Draft (Modified)</h4>
                        {newLines.map((line, i) => {
                            const isModified = oldLines[i] !== line;
                            return (
                                <div key={i} className={`whitespace-pre px-1 ${isModified ? 'bg-indigo-900/40 text-indigo-300 border-l-2 border-indigo-500' : 'hover:bg-slate-800/50'}`}>
                                    {line}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const PropertyEditor = ({ node, selectedPath, updateNode, deleteNode, setShowAddModal }) => {
            if (!node) return (
                <div className="h-full flex flex-col items-center justify-center text-slate-400 animate-fade-in p-4 text-center">
                    <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm text-slate-300">
                        <Icon name="mouse-pointer-2" size={28} />
                    </div>
                    <p className="font-medium text-slate-500 text-sm">Select a widget to edit properties</p>
                </div>
            );

            return (
                <div className="w-full h-full overflow-y-auto custom-scroll animate-fade-in pb-20 md:pb-0">
                    <div className="max-w-3xl mx-auto p-4 md:p-8">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="p-4 md:p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-slate-50/50">
                                <div>
                                    <h2 className="text-lg md:text-xl font-bold text-slate-800 flex items-center gap-2">
                                        {node.type}
                                    </h2>
                                    <div className="text-xs text-slate-400 mt-1 font-mono flex items-center gap-1 overflow-hidden">
                                        <Icon name="folder" size={12} />
                                        <span className="truncate max-w-[200px]">{selectedPath.length ? selectedPath.join(' / ') : 'root'}</span>
                                    </div>
                                </div>
                                <div className="flex gap-2 w-full sm:w-auto">
                                    { (node.type === 'Column' || node.type === 'Row') && (
                                        <button onClick={() => setShowAddModal(true)} className="flex-1 sm:flex-none flex items-center justify-center px-3 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg hover:border-indigo-500 hover:text-indigo-600 text-xs md:text-sm font-medium transition-all shadow-sm">
                                            <Icon name="plus" size={14} className="mr-1.5"/> Add
                                        </button>
                                    )}
                                    {selectedPath.length > 0 && (
                                        <button onClick={() => deleteNode(selectedPath)} className="flex-1 sm:flex-none flex items-center justify-center px-3 py-2 bg-white border border-slate-200 text-rose-600 rounded-lg hover:bg-rose-50 hover:border-rose-200 text-xs md:text-sm font-medium transition-all shadow-sm">
                                            <Icon name="trash-2" size={14} className="mr-1.5"/> Del
                                        </button>
                                    )}
                                </div>
                            </div>

                            <div className="p-4 md:p-6 space-y-5">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Identifier</label>
                                    <input type="text" value={node.id || ''} onChange={(e) => updateNode(selectedPath, { id: e.target.value })} 
                                        className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all placeholder-slate-400"
                                        placeholder="Optional Widget ID"/>
                                </div>
                                    
                                {node.type === 'Text' && (
                                    <>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Content</label>
                                            <input type="text" value={node.data || ''} onChange={(e) => updateNode(selectedPath, { data: e.target.value })} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"/>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Typography</label>
                                            <select value={node.style || 'bodyMedium'} onChange={(e) => updateNode(selectedPath, { style: e.target.value })} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none h-10">
                                                <option value="displayLarge">Display Large (32pt)</option>
                                                <option value="headlineSmall">Headline Small (24pt)</option>
                                                <option value="bodyLarge">Body Large (16pt)</option>
                                                <option value="bodyMedium">Body Medium (14pt)</option>
                                                <option value="labelSmall">Label Small (11pt)</option>
                                            </select>
                                        </div>
                                    </>
                                )}

                                {(node.type === 'Column' || node.type === 'Row') && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Main Axis</label>
                                            <select value={node.mainAxisAlignment || 'start'} onChange={(e) => updateNode(selectedPath, { mainAxisAlignment: e.target.value })} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none h-10">
                                                <option value="start">Start</option>
                                                <option value="center">Center</option>
                                                <option value="end">End</option>
                                                <option value="spaceBetween">Space Between</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Cross Axis</label>
                                            <select value={node.crossAxisAlignment || 'start'} onChange={(e) => updateNode(selectedPath, { crossAxisAlignment: e.target.value })} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none h-10">
                                                <option value="start">Start</option>
                                                <option value="center">Center</option>
                                                <option value="end">End</option>
                                                <option value="stretch">Stretch</option>
                                            </select>
                                        </div>
                                    </div>
                                )}
                                
                                {node.type === 'SizedBox' && (
                                    <div className="grid grid-cols-2 gap-4 md:gap-6">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Height</label>
                                            <input type="number" value={node.height || 0} onChange={(e) => updateNode(selectedPath, { height: Number(e.target.value) })} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Width</label>
                                            <input type="number" value={node.width || 0} onChange={(e) => updateNode(selectedPath, { width: Number(e.target.value) })} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                        </div>
                                    </div>
                                )}

                                {node.type === 'Image' && (
                                    <>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Image URL</label>
                                            <input type="text" value={node.url || ''} onChange={(e) => updateNode(selectedPath, { url: e.target.value })} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 md:gap-6">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Height</label>
                                                <input type="number" value={node.height || 100} onChange={(e) => updateNode(selectedPath, { height: Number(e.target.value) })} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Width</label>
                                                <input type="number" value={node.width || 100} onChange={(e) => updateNode(selectedPath, { width: Number(e.target.value) })} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. MAIN APPLICATION ---
        const App = () => {
            const [specId, setSpecId] = React.useState('new_screen');
            const [spec, setSpec] = React.useState(null);
            const [originalSpec, setOriginalSpec] = React.useState(null); 
            const [selectedPath, setSelectedPath] = React.useState([]); 
            const [loading, setLoading] = React.useState(false);
            const [status, setStatus] = React.useState('Initializing...');
            const [showAddModal, setShowAddModal] = React.useState(false);
            const [mobileTab, setMobileTab] = React.useState('tree'); // 'tree' | 'properties'
            
            // New UI State
            const [showDiffModal, setShowDiffModal] = React.useState(false);
            const [inspectNode, setInspectNode] = React.useState(null);
            
            const [authError, setAuthError] = React.useState(null);
            const [dbError, setDbError] = React.useState(null);

            React.useEffect(() => { initializeApp(); }, []); 
            React.useEffect(() => { if (!loading && !dbError) fetchSpec(); }, [specId]);

            // Auto-switch mobile tab to properties when an item is selected
            React.useEffect(() => {
                if (selectedPath.length > 0 && window.innerWidth < 768) {
                    setMobileTab('properties');
                }
            }, [selectedPath]);

            const initializeApp = async () => {
                setLoading(true); setAuthError(null); setDbError(null);
                try {
                    await auth.signInAnonymously();
                    setStatus('Ready');
                    await fetchSpec();
                } catch (err) {
                    if (err.code === 'auth/configuration-not-found' || err.code === 'auth/operation-not-allowed') {
                        setAuthError('Anonymous Authentication is not enabled in Firebase Console.');
                    } else {
                        setAuthError(err.message);
                    }
                }
                setLoading(false);
            };

            const fetchSpec = async () => {
                setStatus('Loading...');
                try {
                    const doc = await db.collection('aero_specs').doc(specId).get();
                    let data;
                    if (doc.exists && doc.data().spec) {
                        data = doc.data().spec;
                        setStatus('Loaded');
                    } else {
                        data = WIDGET_TEMPLATES['Column'];
                        setStatus('New Spec');
                    }
                    setSpec(data);
                    setOriginalSpec(JSON.parse(JSON.stringify(data))); 
                    setSelectedPath([]); 
                    setDbError(null);
                } catch (err) {
                    if (err.code === 'permission-denied') setDbError('Missing Permissions');
                    else setDbError(err.message);
                    setStatus('Error');
                }
            };

            const saveSpec = async () => {
                setLoading(true); setStatus('Saving...');
                try {
                    await db.collection('aero_specs').doc(specId).set({ spec, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });
                    setOriginalSpec(JSON.parse(JSON.stringify(spec))); 
                    setStatus('Saved!');
                    setTimeout(() => setStatus('Ready'), 3000);
                } catch (err) {
                    if (err.code === 'permission-denied') {
                        setDbError('Missing Permissions');
                        alert("Permission Denied: Check Firebase Rules.");
                    } else {
                        alert("Error saving: " + err.message);
                    }
                    setStatus('Error');
                }
                setLoading(false);
            };

            // --- LOGIC ---
            const getNode = (path, currentSpec = spec) => {
                if (path.length === 0) return currentSpec;
                let current = currentSpec;
                for (let key of path) {
                    if (current && current[key] !== undefined) current = current[key];
                    else return null;
                }
                return current;
            };

            const updateNode = (path, newData) => {
                const newSpec = JSON.parse(JSON.stringify(spec));
                if (path.length === 0) { setSpec({ ...newSpec, ...newData }); return; }
                let current = newSpec;
                for (let i = 0; i < path.length - 1; i++) current = current[path[i]];
                current[path[path.length - 1]] = { ...current[path[path.length - 1]], ...newData };
                setSpec(newSpec);
            };

            const addChild = (parentPath, widgetType) => {
                const newSpec = JSON.parse(JSON.stringify(spec));
                const newWidget = JSON.parse(JSON.stringify(WIDGET_TEMPLATES[widgetType]));
                let parent = newSpec;
                if (parentPath.length > 0) {
                    for (let key of parentPath) parent = parent[key];
                }
                if (!parent.children) parent.children = [];
                parent.children.push(newWidget);
                setSpec(newSpec);
                setShowAddModal(false);
            };

            const deleteNode = (path) => {
                if (path.length === 0) { alert("Cannot delete root node."); return; }
                const newSpec = JSON.parse(JSON.stringify(spec));
                let parent = newSpec;
                for (let i = 0; i < path.length - 2; i++) parent = parent[path[i]];
                parent[path[path.length - 2]].splice(path[path.length - 1], 1);
                setSpec(newSpec);
                setSelectedPath([]); 
            };

            // DnD Logic
            const moveNode = (sourcePath, targetPath) => {
                if (sourcePath.length === 0) { alert("Cannot move root."); return; }
                if (JSON.stringify(sourcePath) === JSON.stringify(targetPath)) return;
                
                // Prevent dropping parent into its own child
                const isParentOfTarget = sourcePath.length < targetPath.length && 
                    sourcePath.every((val, index) => val === targetPath[index]);
                
                if (isParentOfTarget) {
                    alert("Cannot move a parent node into its own child.");
                    return;
                }

                const newSpec = JSON.parse(JSON.stringify(spec));

                let sourceParent = newSpec;
                for(let i=0; i<sourcePath.length-2; i++) sourceParent = sourceParent[sourcePath[i]];
                const sourceIndex = sourcePath[sourcePath.length-1];
                const itemToMove = sourceParent[sourcePath[sourcePath.length-2]][sourceIndex];

                sourceParent[sourcePath[sourcePath.length-2]].splice(sourceIndex, 1);

                let targetParent = newSpec;
                for(let i=0; i<targetPath.length-2; i++) targetParent = targetParent[targetPath[i]];
                let targetIndex = targetPath[targetPath.length-1];
                
                const sameParent = sourcePath.length === targetPath.length && 
                    sourcePath.slice(0, -1).every((val, idx) => val === targetPath[idx]);

                if (sameParent && sourceIndex < targetIndex) {
                     targetIndex--;
                }

                targetParent[targetPath[targetPath.length-2]].splice(targetIndex, 0, itemToMove);

                setSpec(newSpec);
                setSelectedPath(targetPath); 
            };

            // --- RENDER ---
            
            if ((authError || dbError === 'Missing Permissions') && !spec) {
                return (
                     <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 animate-fade-in">
                            <h2 className="text-xl font-bold text-red-600 mb-4 flex items-center gap-2">
                                <Icon name="alert-triangle" size={24}/> Connection Issue
                            </h2>
                            {authError && <div className="mb-4 text-sm text-slate-700"><strong>Auth Error:</strong> {authError}</div>}
                            {dbError === 'Missing Permissions' && <div className="mb-4 text-sm text-slate-700"><strong>Database Error:</strong> Check Firestore Rules.</div>}
                            <button onClick={initializeApp} className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Retry</button>
                        </div>
                    </div>
                );
            }

            if (!spec) return (
                <div className="flex flex-col items-center justify-center h-screen bg-slate-50 text-slate-400 gap-4">
                    <div className="animate-spin text-indigo-500"><Icon name="loader-2" size={40}/></div> 
                    <p className="font-medium animate-pulse">{status}</p>
                </div>
            );

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-800 bg-slate-50">
                    
                    {/* TOP NAVIGATION BAR */}
                    <header className="h-16 glass z-20 px-4 md:px-6 flex items-center justify-between shrink-0 sticky top-0">
                        <div className="flex items-center gap-4 md:gap-8">
                            {/* Brand */}
                            <div className="font-bold text-lg text-slate-800 flex items-center gap-2 tracking-tight">
                                <div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white text-sm font-bold shadow-md shadow-indigo-200">A</div>
                                <span className="hidden sm:inline">Aero Console</span>
                            </div>
                            
                            {/* Spec ID Control */}
                            <div className="flex items-center gap-1 md:gap-2 bg-slate-100 p-1 rounded-lg border border-slate-200">
                                <span className="pl-2 text-xs font-bold text-slate-400 uppercase hidden sm:inline">ID:</span>
                                <input 
                                    className="w-20 md:w-32 text-sm bg-transparent border-none focus:outline-none text-slate-700 font-mono" 
                                    value={specId} 
                                    onChange={(e)=>setSpecId(e.target.value)}
                                />
                                <button onClick={() => fetchSpec()} className="px-2 md:px-3 py-1 bg-white text-slate-600 rounded-md text-xs font-bold hover:text-indigo-600 hover:shadow-sm transition-all shadow-sm">
                                    Load
                                </button>
                            </div>
                        </div>

                        <div className="flex items-center gap-2 md:gap-3">
                            <div className={`text-[10px] font-bold px-2 md:px-3 py-1.5 rounded-full uppercase tracking-wider hidden sm:block ${status.includes('Error') ? 'bg-rose-100 text-rose-600' : 'bg-emerald-50 text-emerald-600 border border-emerald-100'}`}>
                                {status}
                            </div>

                            {/* Diff / Code Toggle */}
                            <button 
                                onClick={() => setShowDiffModal(true)}
                                className="flex items-center gap-2 px-2 md:px-3 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium transition-colors"
                            >
                                <Icon name="git-diff" size={18} /> 
                                <span className="hidden sm:inline">Code</span>
                            </button>

                            {/* Primary Action: Publish */}
                            <button 
                                onClick={saveSpec}
                                disabled={loading}
                                className={`flex items-center gap-2 px-3 md:px-5 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-200 transition-all transform active:scale-95
                                    ${loading ? 'bg-slate-200 text-slate-400 cursor-not-allowed shadow-none' : 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:to-purple-700'}
                                `}
                            >
                                {loading ? <Icon name="loader-2" className="animate-spin" size={16}/> : <Icon name="rocket" size={16}/>}
                                <span className="hidden sm:inline">Publish</span>
                            </button>
                        </div>
                    </header>
                    
                    {/* MOBILE TAB SWITCHER */}
                    <div className="md:hidden flex border-b border-slate-200 bg-white">
                        <button 
                            onClick={() => setMobileTab('tree')}
                            className={`flex-1 py-3 text-sm font-medium flex items-center justify-center gap-2 ${mobileTab === 'tree' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500'}`}
                        >
                            <Icon name="layers" size={14}/> Layers
                        </button>
                        <button 
                            onClick={() => setMobileTab('properties')}
                            className={`flex-1 py-3 text-sm font-medium flex items-center justify-center gap-2 ${mobileTab === 'properties' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500'}`}
                        >
                            <Icon name="sliders" size={14}/> Properties
                        </button>
                    </div>

                    {/* MAIN CONTENT AREA */}
                    <div className="flex flex-1 overflow-hidden relative">
                        {/* LEFT: WIDGET TREE (Responsive visibility) */}
                        <div className={`
                            w-full md:w-72 bg-white border-r border-slate-200 flex flex-col z-10
                            ${mobileTab === 'tree' ? 'flex' : 'hidden md:flex'}
                        `}>
                            <div className="p-4 border-b border-slate-100 bg-slate-50/50">
                                <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex justify-between items-center">
                                    Hierarchy
                                    <span className="bg-slate-200 text-slate-500 px-1.5 py-0.5 rounded text-[9px]">Root</span>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto custom-scroll py-3 px-2">
                                <WidgetTreeItem 
                                    node={spec} 
                                    path={[]} 
                                    index={0} 
                                    selectedPath={selectedPath}
                                    setSelectedPath={setSelectedPath}
                                    setInspectNode={setInspectNode}
                                    moveNode={moveNode}
                                />
                            </div>
                        </div>

                        {/* CENTER: PROPERTY EDITOR (Responsive visibility) */}
                        <div className={`
                            flex-1 bg-slate-50 relative
                            ${mobileTab === 'properties' ? 'flex' : 'hidden md:flex'}
                        `}>
                            <PropertyEditor 
                                node={getNode(selectedPath)}
                                selectedPath={selectedPath}
                                updateNode={updateNode}
                                deleteNode={deleteNode}
                                setShowAddModal={setShowAddModal}
                            />
                        </div>
                    </div>

                    {/* --- MODALS --- */}

                    {/* CODE / DIFF MODAL */}
                    {showDiffModal && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4 md:p-8" onClick={() => setShowDiffModal(false)}>
                            <div className="bg-slate-900 rounded-xl shadow-2xl w-full max-w-5xl h-[90vh] md:h-[85vh] flex flex-col border border-slate-700 overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-indigo-500/20 rounded-lg text-indigo-400"><Icon name="git-diff" size={20}/></div>
                                        <div>
                                            <h3 className="text-white font-bold text-lg">Diff Viewer</h3>
                                            <p className="text-slate-400 text-xs hidden sm:block">Comparing server version vs local changes</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setShowDiffModal(false)} className="text-slate-400 hover:text-white transition-colors p-2 hover:bg-slate-700 rounded-lg"><Icon name="x" size={20}/></button>
                                </div>
                                <div className="flex-1 overflow-hidden">
                                    <DiffViewer originalSpec={originalSpec} spec={spec} />
                                </div>
                                <div className="p-4 border-t border-slate-700 bg-slate-800 flex justify-end gap-3">
                                    <button onClick={() => setShowDiffModal(false)} className="px-4 py-2 text-slate-300 hover:text-white text-sm font-medium">Close</button>
                                    <button onClick={() => { saveSpec(); setShowDiffModal(false); }} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow-lg">Merge & Publish</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* INSPECT MODAL (Single Node JSON) */}
                    {inspectNode && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={() => setInspectNode(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-[95%] md:w-[500px] max-h-[80vh] flex flex-col border border-slate-200 m-4 overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <div className="flex items-center gap-2 text-slate-700">
                                        <Icon name="eye" size={18} className="text-indigo-500"/>
                                        <span className="font-bold text-sm">Inspect: {inspectNode.type}</span>
                                    </div>
                                    <button onClick={() => setInspectNode(null)} className="text-slate-400 hover:text-slate-600 transition-colors"><Icon name="x" size={20}/></button>
                                </div>
                                <div className="p-0 overflow-y-auto custom-scroll bg-slate-900">
                                    <pre className="p-6 text-xs font-mono text-emerald-400 whitespace-pre-wrap font-medium leading-relaxed">
                                        {JSON.stringify(inspectNode, (key, value) => (key === 'children' ? '[Array]' : value), 2)}
                                    </pre>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ADD WIDGET MODAL */}
                    {showAddModal && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={() => setShowAddModal(false)}>
                            <div className="bg-white rounded-2xl shadow-2xl w-[95%] md:w-[600px] overflow-hidden transform scale-100 transition-all border border-slate-100" onClick={e => e.stopPropagation()}>
                                <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                    <h3 className="font-bold text-slate-800 text-lg">Add Widget</h3>
                                    <button onClick={() => setShowAddModal(false)} className="text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-full hover:bg-slate-100"><Icon name="x" size={20}/></button>
                                </div>
                                <div className="p-6 grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 max-h-[60vh] overflow-y-auto custom-scroll">
                                    {Object.keys(WIDGET_TEMPLATES).map(key => (
                                        <button 
                                            key={key}
                                            onClick={() => addChild(selectedPath, key)}
                                            className="group flex flex-col items-center justify-center p-4 md:p-6 border border-slate-200 rounded-xl hover:border-indigo-500 hover:bg-indigo-50/30 hover:shadow-lg transition-all duration-200 bg-white"
                                        >
                                            <div className="bg-slate-100 p-3 md:p-4 rounded-full mb-3 text-slate-500 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors">
                                                {key === 'Column' || key === 'Row' ? <Icon name="layout" size={24} /> : 
                                                 key === 'Text' ? <Icon name="type" size={24} /> :
                                                 key === 'Image' ? <Icon name="image" size={24} /> :
                                                 <Icon name="box" size={24} />}
                                            </div>
                                            <span className="text-xs font-bold text-slate-600 group-hover:text-indigo-700">{key}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
